@page "/"
@using System.Text.Json
@using Blazored.LocalStorage
@using EPTools.Blazor.Pages.Dialogs
@using EPTools.Blazor.Pages.Partials
@using EPTools.Blazor.Services
@using EPTools.Core.Models.Ego
@inject AppDataService AppData
@inject LifepathService LifepathService
@inject EgoService EgoService
@inject IJSRuntime JsRuntime
@inject ILocalStorageService LocalStorage
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudButton Color="Color.Primary" @onclick="GenerateRandomCharacter">Generate Lifepath</MudButton>
<MudButton Color="Color.Secondary" @onclick="DownloadText">Export</MudButton>
<MudButton Color="Color.Secondary" @onclick="ImportText">Import</MudButton>
<MudButton Color="Color.Success" @onclick="SaveCharacter">Save</MudButton>
<MudButton Color="Color.Dark" @onclick="ResetCharacter">Reset</MudButton>
<CascadingValue Value="_egoModel" Name="EgoModel">

    <MudOverlay Visible="_loading" DarkBackground="true" Absolute="true" ZIndex="9999">
        <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
    </MudOverlay>
    <MudGrid Spacing="2">
        
        <MudItem xs="12" sm="4">
            <MudTextField Label="Name" 
                          @bind-Value="_egoModel.Name" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Background" 
                          @bind-Value="_egoModel.Background" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Career" 
                          @bind-Value="_egoModel.Career" 
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudTextField Label="Interest" 
                          @bind-Value="_egoModel.Interest" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Faction" 
                          @bind-Value="_egoModel.Faction" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Languages" 
                          @bind-Value="_egoModel.Languages" 
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudNumericField Label="Age" 
                             @bind-Value="_egoModel.EgoAge" 
                             Variant="Variant.Outlined" 
                             Min="0" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Sex" 
                          @bind-Value="_egoModel.EgoSex" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Gender" 
                          @bind-Value="_egoModel.EgoGender" 
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudTextField Label="Motivations" 
                          @bind-Value="MotivationsDisplay" 
                          Variant="Variant.Outlined"
                          HelperText="Comma separated (e.g. +Survival, -Hypercorps)" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudNumericField Label="Ego Flex" 
                             @bind-Value="_egoModel.EgoFlex" 
                             Variant="Variant.Outlined" 
                             Min="0" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Notes" 
                          @bind-Value="_egoModel.Notes" 
                          Variant="Variant.Outlined" 
                          Lines="1" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudButton Color="Color.Default" @onclick="ShowPlayerChoice">Player Choices</MudButton>
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudButton Color="Color.Default" @onclick="ShowLifepathHistory">Lifepath History</MudButton>
        </MudItem>
    </MudGrid>
    <CharacterAptitude Aptitudes="@_egoModel.Aptitudes"/>

    <MudTabs>
        <MudTabPanel Text="Network" icon="@Icons.Material.Filled.Groups">
            <CharacterNetwork Identities="@_egoModel.Identities" OnIdentityAdded="HandleIdentityAdded"></CharacterNetwork>
        </MudTabPanel>
        <MudTabPanel Text="Skills" icon="@Icons.Material.Filled.Psychology">
            <CharacterSkills />
        </MudTabPanel>
        <MudTabPanel Text="Morph" icon="@Icons.Material.Filled.Person">
            <CharacterMorphs Morphs="@_egoModel.Morphs"></CharacterMorphs>
        </MudTabPanel>
        <MudTabPanel Text="Gear" icon="@Icons.Material.Filled.Hardware">
            <CharacterGear></CharacterGear>
        </MudTabPanel>
        <MudTabPanel Text="Traits" Icon="@Icons.Material.Filled.Portrait">
            <CharacterTraits EgoTraits="@_egoModel.EgoTraits" />
        </MudTabPanel>
        <MudTabPanel Text="PSI" Icon="@Icons.Material.Filled.Coronavirus">
            <CharacterPsi PsiModel="@_egoModel.Psi"/>
        </MudTabPanel>
    </MudTabs>

</CascadingValue>

@code {
    private bool _loading = true; // Start as true
    private Ego _egoModel = new Ego();
    private const string StorageKey = "EP_CurrentCharacter";

    protected override async Task OnInitializedAsync()
    {
        // 1. Try to load from Browser Storage first
        var storedEgo = await LocalStorage.GetItemAsync<Ego>(StorageKey);

        if (storedEgo != null)
        {
            _egoModel = storedEgo;
            Snackbar.Add("Character loaded from storage.", Severity.Success);
        }
        else
        {
            // 2. If nothing in storage, create a new blank one (or load default)
            _egoModel = await EgoService.GetDefaults();
        }

        _loading = false;
    }
    
    private async Task ResetCharacter()
    {
        await LocalStorage.RemoveItemAsync(StorageKey);
        _egoModel = await EgoService.GetDefaults();
        Snackbar.Add("Character reset.", Severity.Info);
    }
    
    // Call this method whenever you want to persist the data
    private async Task SaveCharacter()
    {
        // This serializes the Ego object to JSON and saves it to LocalStorage
        await LocalStorage.SetItemAsync(StorageKey, _egoModel);
        
        Snackbar.Add("Character saved!", Severity.Success);
    }

    private async Task ShowPlayerChoice()
    {
        var parameters = new DialogParameters<TextAreaDialog> {
            { x => x.PromptText, "Player Choices"},
            { x => x.Value, string.Join(Environment.NewLine, _egoModel.PlayerChoices) }, 
            { x => x.Lines, 10 } 
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<TextAreaDialog>("Player Choices", parameters, options);
        var result = await dialog.Result;

        if (result is {Canceled: false, Data: string playerChoices })
        {
            _egoModel.PlayerChoices = playerChoices.Split(Environment.NewLine).ToList();
        }
    }

    private async Task ShowLifepathHistory()
    {
        var parameters = new DialogParameters<ListStringMessageBox> {
            { x => x.Message, _egoModel.CharacterGenerationOutput }, 

        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<ListStringMessageBox>("Lifepath History", parameters, options);
    }

    private async Task GenerateRandomCharacter()
    {
        _loading = true;
        var newEgo = await LifepathService.GenerateEgo();
        AppData.Ego = newEgo;
        _egoModel = newEgo;
        StateHasChanged();
        _loading = false;
    }

    async Task DownloadText()
    {
        // Generate a text file
        var s = JsonSerializer.Serialize(_egoModel);
        byte[] file = System.Text.Encoding.UTF8.GetBytes(s);
        await JsRuntime.InvokeVoidAsync("BlazorDownloadFile", "Character.json", "text/plain", file);
    }

    async Task ImportText()
    {
        var parameters = new DialogParameters<TextAreaDialog> {
            { x => x.PromptText, "Import Character"},
            { x => x.Value, string.Empty }, 
            { x => x.Lines, 10 } 
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        
        var dialog = await DialogService.ShowAsync<TextAreaDialog>("Import Character", parameters, options);
        var result = await dialog.Result;

        if (result is {Canceled: false, Data: string importedEgo})
        {
            try
            {
                var importedEgoObject = JsonSerializer.Deserialize<Ego>(importedEgo);
                if (importedEgoObject is not null)
                {
                    _egoModel = importedEgoObject;
                    await SaveCharacter();
                    Snackbar.Add("Character Imported", Severity.Success);
                    StateHasChanged();
                }
                else
                {
                    Snackbar.Add("Error in import process", Severity.Error);
                }
                
            }
            catch (Exception e)
            {
                Console.WriteLine(e);
                Snackbar.Add("Error in import process", Severity.Error);
            }
            
        }

        
    }
    
    private void HandleIdentityAdded(Identity newIdentity)
    {
        // ACTUAL LOGIC: Parent modifies the list
        _egoModel.Identities.Add(newIdentity);
        
        // Force UI refresh (Blazor usually does this automatically for EventCallbacks)
        StateHasChanged(); 
    }
    
    // HELPER: Handles the conversion between List<string> and the Text Field
    private string MotivationsDisplay
    {
        get => string.Join(", ", _egoModel.Motivations);
        set
        {
            if (string.IsNullOrWhiteSpace(value))
            {
                _egoModel.Motivations = new List<string>();
            }
            else
            {
                // Splits by comma, trims whitespace, and removes empty entries
                _egoModel.Motivations = value
                    .Split(',', StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries)
                    .ToList();
            }
        }
    }
}