@page "/"
@using EPTools.Blazor.Pages.Partials
@using EPTools.Blazor.Services
@using EPTools.Blazor.ViewModels
@using EPTools.Core.Models.Ego
@inject AppDataService AppData
@inject LifepathService LifepathService
@inject EgoService EgoService
@inject IJSRuntime JsRuntime

<MudButton Color="Color.Primary" @onclick="GenerateRandomCharacter" >Generate Random Character</MudButton>
<MudButton Color="Color.Secondary" @onclick="DownloadText">Export Character</MudButton>
<CascadingValue Value="_egoModel" Name="EgoModel">

    <MudOverlay Visible="_loading" DarkBackground="true" Absolute="true" ZIndex="9999">
        <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
    </MudOverlay>
    <MudGrid Spacing="2">
        
        <MudItem xs="12" sm="4">
            <MudTextField Label="Name" 
                          @bind-Value="_egoModel.Name" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Background" 
                          @bind-Value="_egoModel.Background" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Career" 
                          @bind-Value="_egoModel.Career" 
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudTextField Label="Interest" 
                          @bind-Value="_egoModel.Interest" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Faction" 
                          @bind-Value="_egoModel.Faction" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Languages" 
                          @bind-Value="_egoModel.Languages" 
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudNumericField Label="Age" 
                             @bind-Value="_egoModel.EgoAge" 
                             Variant="Variant.Outlined" 
                             Min="0" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Sex" 
                          @bind-Value="_egoModel.EgoSex" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Gender" 
                          @bind-Value="_egoModel.EgoGender" 
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudTextField Label="Motivations" 
                          @bind-Value="MotivationsDisplay" 
                          Variant="Variant.Outlined"
                          HelperText="Comma separated (e.g. +Survival, -Hypercorps)" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudNumericField Label="Ego Flex" 
                             @bind-Value="_egoModel.EgoFlex" 
                             Variant="Variant.Outlined" 
                             Min="0" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Notes" 
                          @bind-Value="_egoModel.Notes" 
                          Variant="Variant.Outlined" 
                          Lines="1" />
        </MudItem>

    </MudGrid>
    <CharacterAptitude Aptitudes="@_egoModel.Aptitudes"></CharacterAptitude>

    <MudTabs>
        <MudTabPanel Text="Network" icon="@Icons.Material.Filled.NetworkWifi">
            <CharacterNetwork Identities="@_egoModel.Identities" OnIdentityAdded="HandleIdentityAdded"></CharacterNetwork>
        </MudTabPanel>
        <MudTabPanel Text="Skills" icon="@Icons.Material.Filled.Casino">
            <CharacterSkills />
        </MudTabPanel>
        <MudTabPanel Text="Morph" icon="@Icons.Material.Filled.Accessibility">
            <CharacterMorphs Morphs="@_egoModel.Morphs"></CharacterMorphs>
        </MudTabPanel>
        <MudTabPanel Text="Gear" icon="@Icons.Material.Filled.AllInbox">
            <MudText>Content Disabled</MudText>
        </MudTabPanel>
    </MudTabs>

</CascadingValue>

@code {
    private bool _loading = true; // Start as true
    private Ego _egoModel = new Ego();
    
    protected override async Task OnInitializedAsync()
    {
        if (AppData.Ego == null)
        {
            AppData.Ego = await EgoService.GetDefaults();
            _egoModel = AppData.Ego;
        }
        else
        {
            _egoModel = AppData.Ego;
        }
        
        _loading = false;
    }

    private async Task GenerateRandomCharacter()
    {
        _loading = true;
        var newEgo = await LifepathService.GenerateEgo();
        AppData.Ego = newEgo;
        _egoModel = newEgo;
        StateHasChanged();
        _loading = false;
    }

    async Task DownloadText()
    {
        // Generate a text file
        var s = System.Text.Json.JsonSerializer.Serialize(_egoModel);
        byte[] file = System.Text.Encoding.UTF8.GetBytes(s);
        await JsRuntime.InvokeVoidAsync("BlazorDownloadFile", "Character.json", "text/plain", file);
    }
    
    private void HandleIdentityAdded(Identity newIdentity)
    {
        // ACTUAL LOGIC: Parent modifies the list
        _egoModel.Identities.Add(newIdentity);
        
        // Force UI refresh (Blazor usually does this automatically for EventCallbacks)
        StateHasChanged(); 
    }
    
    // HELPER: Handles the conversion between List<string> and the Text Field
    private string MotivationsDisplay
    {
        get => string.Join(", ", _egoModel.Motivations);
        set
        {
            if (string.IsNullOrWhiteSpace(value))
            {
                _egoModel.Motivations = new List<string>();
            }
            else
            {
                // Splits by comma, trims whitespace, and removes empty entries
                _egoModel.Motivations = value
                    .Split(',', StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries)
                    .ToList();
            }
        }
    }
}