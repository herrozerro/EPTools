@page "/"
@using EPTools.Blazor.Pages.Partials
@using EPTools.Blazor.Services
@using EPTools.Blazor.ViewModels
@using EPTools.Core.Models.Ego
@inject AppDataService AppData
@inject LifepathService LifepathService
@inject EgoService EgoService
@inject IJSRuntime JsRuntime

<MudButton Color="Color.Primary" @onclick="GenerateRandomCharacter" >Generate Random Character</MudButton>
<MudButton Color="Color.Secondary" @onclick="DownloadText">Export Character</MudButton>
<CascadingValue Value="_egoModel" Name="EgoModel">

    <MudOverlay Visible="_loading" DarkBackground="true" Absolute="true" ZIndex="9999">
        <MudProgressCircular Color="Color.Secondary" Indeterminate="true" />
    </MudOverlay>
    <MudGrid Spacing="2">
        
        <MudItem xs="12" sm="4">
            <MudTextField Label="Name" 
                          @bind-Value="_egoModel.Name" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Background" 
                          @bind-Value="_egoModel.Background" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Career" 
                          @bind-Value="_egoModel.Career" 
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudTextField Label="Interest" 
                          @bind-Value="_egoModel.Interest" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Faction" 
                          @bind-Value="_egoModel.Faction" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Languages" 
                          @bind-Value="_egoModel.Languages" 
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudNumericField Label="Age" 
                             @bind-Value="_egoModel.EgoAge" 
                             Variant="Variant.Outlined" 
                             Min="0" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Sex" 
                          @bind-Value="_egoModel.EgoSex" 
                          Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Gender" 
                          @bind-Value="_egoModel.EgoGender" 
                          Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12" sm="4">
            <MudTextField Label="Motivations" 
                          @bind-Value="MotivationsDisplay" 
                          Variant="Variant.Outlined"
                          HelperText="Comma separated (e.g. +Survival, -Hypercorps)" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudNumericField Label="Ego Flex" 
                             @bind-Value="_egoModel.EgoFlex" 
                             Variant="Variant.Outlined" 
                             Min="0" />
        </MudItem>
        <MudItem xs="12" sm="4">
            <MudTextField Label="Notes" 
                          @bind-Value="_egoModel.Notes" 
                          Variant="Variant.Outlined" 
                          Lines="1" />
        </MudItem>

    </MudGrid>
    <CharacterAptitude Aptitudes="@_egoModel.Aptitudes"></CharacterAptitude>

    <MudTabs>
        <MudTabPanel Text="Network" icon="@Icons.Material.Filled.NetworkWifi">
            <CharacterNetwork Identities="@AppData.Ego.Identities" OnIdentityAdded="HandleIdentityAdded"></CharacterNetwork>
        </MudTabPanel>
        <MudTabPanel Text="Skills" icon="@Icons.Material.Filled.Casino">
            <CharacterSkills />
        </MudTabPanel>
        <MudTabPanel Text="Morph" icon="@Icons.Material.Filled.Accessibility">
            <CharacterMorphs Morphs="@_egoModel.Morphs"></CharacterMorphs>
        </MudTabPanel>
        <MudTabPanel Text="Gear" icon="@Icons.Material.Filled.AllInbox">
            <MudText>Content Disabled</MudText>
        </MudTabPanel>
    </MudTabs>

</CascadingValue>

@code {
    private bool _loading = true; // Start as true
    private Ego _egoModel = new Ego();
    private List<SkillViewModel> _skillViewModels = new();
    
    protected override async Task OnInitializedAsync()
    {
        if (AppData.Ego == null)
        {
            AppData.Ego = await EgoService.GetDefaults();
            _egoModel = AppData.Ego;
        }
        
        _loading = false;
    }

    private async Task GenerateRandomCharacter()
    {
        _loading = true;
        var newEgo = await LifepathService.GenerateEgo();
        AppData.Ego = newEgo;
        _egoModel = newEgo;
        _loading = false;
    }

    async Task DownloadText()
    {
        // Generate a text file
        var s = System.Text.Json.JsonSerializer.Serialize(_egoModel);
        byte[] file = System.Text.Encoding.UTF8.GetBytes(s);
        await JsRuntime.InvokeVoidAsync("BlazorDownloadFile", "Character.json", "text/plain", file);
    }
    
    private void HandleIdentityAdded(Identity newIdentity)
    {
        // ACTUAL LOGIC: Parent modifies the list
        _egoModel.Identities.Add(newIdentity);
        
        // Force UI refresh (Blazor usually does this automatically for EventCallbacks)
        StateHasChanged(); 
    }
    
    // HELPER: Handles the conversion between List<string> and the Text Field
    private string MotivationsDisplay
    {
        get => string.Join(", ", _egoModel.Motivations);
        set
        {
            if (string.IsNullOrWhiteSpace(value))
            {
                _egoModel.Motivations = new List<string>();
            }
            else
            {
                // Splits by comma, trims whitespace, and removes empty entries
                _egoModel.Motivations = value
                    .Split(',', StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries)
                    .ToList();
            }
        }
    }
    
    private List<SkillViewModel> BuildSkillViewModels()
    {
        var models = AppData.Ego.Skills.Select(x =>
            new SkillViewModel()
            {
                Id = x.Id,
                Name = x.Name,
                Aptitude = x.Aptitude,
                Rank = x.Rank,
                Specialization = x.Specialization,
                Type = x.SkillType,
                TotalValue = AppData.Ego.SkillTotal(x)
            })
            .ToList();
        return models;
    }

    private void DeleteSkill(Guid skillId)
    {
        var skillToRemove = AppData.Ego.Skills.First(x => x.Id == skillId);
        AppData.Ego.Skills.Remove(skillToRemove);
        var skillViewModelToRemove = _skillViewModels.First(x => x.Id == skillId);
        _skillViewModels.Remove(skillViewModelToRemove);
    }
    
    private void AddSkill(SkillType skillType)
    {
        Console.WriteLine($"Trying to add Skill of Type: {skillType}");
        var id = Guid.NewGuid();
        var skill = new EgoSkill()
        {
            Aptitude = "Cognition",
            Rank = 0,
            Specialization = string.Empty,
            Name = "New Skill",
            SkillTotal = 0,
            SkillType = skillType,
            Id = id
        };
        AppData.Ego.Skills.Add(skill);
        _skillViewModels.Add(new SkillViewModel()
        {
            Aptitude = skill.Aptitude,
            Id = skill.Id,
            Name = skill.Name,
            Rank = skill.Rank,
            Specialization = skill.Specialization,
            TotalValue = skill.SkillTotal,
            Type = skillType
        });
    }
    
    private void HandleSkillUpdate((Guid, string, int, string) data)
    {
        // 1. Deconstruct the tuple for clarity
        var skillId = data.Item1;
        var newAttributeName = data.Item2;
        var newSkillRank = data.Item3;
        var newSkillSpecialization = data.Item4;
        
        Console.WriteLine("Updating Skill {0}, rank {1}, aptitude {2}", skillId, newSkillRank, newAttributeName);
        
        // 2. Find the "real" skill in your source of truth
        var skillToUpdate = AppData.Ego.Skills.Find(s => s.Id == skillId);
        
        if (skillToUpdate != null)
        {
            // 3. Update the "source of truth" (the model)
            skillToUpdate.Aptitude = newAttributeName;
            skillToUpdate.Rank = newSkillRank;
            skillToUpdate.Specialization = newSkillSpecialization;
        }
    }
}