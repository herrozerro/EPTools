@using EPTools.Core.Models.EPDataModels
@using System.Text.Json

<MudDialog>
    <DialogContent>
        <MudContainer Style="max-height: 600px; overflow-y: auto;">
            
            <MudGrid>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_workingGear.Name" Label="Name" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @bind-Value="_workingGear.Category" Label="Category" Variant="Variant.Outlined" Margin="Margin.Dense"/>
                </MudItem>
                <MudItem xs="6">
                    <MudTextField @bind-Value="_workingGear.Subcategory" Label="Subcategory" Variant="Variant.Outlined" Margin="Margin.Dense"/>
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_workingGear.Description" Label="Description" Variant="Variant.Outlined" Lines="3" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_workingGear.Complexity" Label="Complexity" Variant="Variant.Outlined" Margin="Margin.Dense" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_workingGear.Reference" Label="Reference / Page" Variant="Variant.Text" Margin="Margin.Dense" />
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-4" />

            @switch (_workingGear)
            {
                case GearArmor armor:
                    // ============================================================
                    // ARMOR SECTION (Copy this block structure for other types)
                    // ============================================================
                    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">Armor Stats</MudText>
                    <MudGrid>
                        <MudItem xs="6">
                            <MudNumericField @bind-Value="armor.Energy" Label="Energy Armor" Variant="Variant.Outlined" Margin="Margin.Dense" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudNumericField @bind-Value="armor.Kinetic" Label="Kinetic Armor" Variant="Variant.Outlined" Margin="Margin.Dense" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudCheckBox @bind-Value="armor.Stackable" Label="Stackable with other armor?" Color="Color.Primary" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="armor.WareType" Label="Ware Type (if built-in)" HelperText="B, C, H" Variant="Variant.Text" />
                        </MudItem>
                    </MudGrid>
                    // ============================================================
                    break;
                case GearWare ware:
                    <MudText Typo="Typo.h6" Color="Color.Primary" Class="mb-2">Ware Details</MudText>
                    <MudGrid>
                        <MudItem xs="12" Class="d-flex gap-4">
                            <MudCheckBox @bind-Value="ware.Bioware" Label="Bioware" Color="Color.Success" />
                            <MudCheckBox @bind-Value="ware.Cyberware" Label="Cyberware" Color="Color.Info" />
                            <MudCheckBox @bind-Value="ware.Hardware" Label="Hardware" Color="Color.Info" />
                            <MudCheckBox @bind-Value="ware.Meshware" Label="Meshware" Color="Color.Warning" />
                            <MudCheckBox @bind-Value="ware.Nanoware" Label="Nanoware" Color="Color.Info" />
                        </MudItem>
                    </MudGrid>
                    break;
            }

        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit">Save Changes</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public required IMudDialogInstance MudDialog { get; set; }

    [Parameter] public required Gear OriginalGear { get; set; }

    private Gear? _workingGear;

    protected override void OnInitialized()
    {
        var json = JsonSerializer.Serialize(OriginalGear, typeof(Gear));
        _workingGear = JsonSerializer.Deserialize<Gear>(json);
    }

    private void Submit()
    {
        // Return the modified clone
        MudDialog.Close(DialogResult.Ok(_workingGear));
    }

    private void Cancel() => MudDialog.Cancel();
}