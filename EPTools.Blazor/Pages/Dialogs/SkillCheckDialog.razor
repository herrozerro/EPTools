@using EPTools.Core.Models.Ego
@using System.Security.Cryptography

<MudDialog>
    <DialogContent>
        <MudGrid Spacing="2">
            
            <MudItem xs="12" md="5">
                
                <div class="d-flex align-center gap-3 mb-4">
                    <MudAvatar Size="Size.Large" Color="Color.Dark">@Ego.Name.FirstOrDefault()</MudAvatar>
                    <div>
                        <MudText Typo="Typo.h6">@Ego.Name</MudText>
                        <MudText Typo="Typo.caption">Morph Placeholder</MudText>
                    </div>
                </div>

                <MudPaper Class="pa-3 mb-3" Outlined="true" Style="border-left: 4px solid var(--mud-palette-primary);">
                    <div class="d-flex justify-space-between align-center">
                        <div>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">SKILL</MudText>
                            <MudText Typo="Typo.h6">@SkillName</MudText>
                            <MudText Typo="Typo.body2" Class="mud-text-secondary">
                                Linked: @LinkedAptitude (@BaseAptitudeValue)
                            </MudText>
                        </div>
                        <div class="d-flex flex-column align-end">
                             <MudText Typo="Typo.h4" Color="Color.Primary">@BaseSkillTotal</MudText>
                             <MudText Typo="Typo.caption">Base</MudText>
                        </div>
                    </div>
                </MudPaper>

                <MudPaper Class="pa-3 mb-3" Outlined="true">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">ACTION & TIME</MudText>
                    
                    <MudGrid Spacing="1">
                        <MudItem xs="6">
                            <MudSelect T="string" Label="Type" Variant="Variant.Text" Dense="true" @bind-Value="_actionType">
                                <MudSelectItem Value="@("Complex")" />
                                <MudSelectItem Value="@("Automatic")" />
                                <MudSelectItem Value="@("Quick")" />
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="6">
                            <MudSelect T="string" Label="Subtype" Variant="Variant.Text" Dense="true" @bind-Value="_actionSubtype">
                                <MudSelectItem Value="@("Physical")" />
                                <MudSelectItem Value="@("Mental")" />
                                <MudSelectItem Value="@("Mesh")" />
                            </MudSelect>
                        </MudItem>
                    </MudGrid>

                    <div class="mt-4 px-2">
                        <MudText Typo="Typo.body2">Take Time: <b class="mud-text-primary">@_timeLabel</b> (@(_timeBonus > 0 ? "+" : "")@_timeBonus)</MudText>
                        <MudSlider T="int" Min="0" Max="5" Step="1" ValueChanged="OnTimeSliderChanged" Color="Color.Info" Class="mt-2" />
                    </div>
                </MudPaper>

                <MudPaper Class="pa-3" Outlined="true">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">POOLS</MudText>
                    <div class="d-flex justify-space-between align-center mt-2">
                        
                        <MudTooltip Text="Cost: 1 Insight/Moxie/Vigor">
                            <MudToggleIconButton @bind-Toggled="_ignoreMods"
                                                 Icon="@Icons.Material.Outlined.FilterAlt" Color="Color.Default"
                                                 ToggledIcon="@Icons.Material.Filled.FilterAlt" ToggledColor="Color.Info"
                                                 Title="Ignore Negative Mods" />
                        </MudTooltip>
                        <MudText Typo="Typo.caption">Ignore Mods</MudText>

                        <MudTooltip Text="Cost: 1 Flex/Moxie">
                             <MudToggleIconButton @bind-Toggled="_usePoolBonus"
                                                 Icon="@Icons.Material.Outlined.AddCircleOutline" Color="Color.Default"
                                                 ToggledIcon="@Icons.Material.Filled.AddCircle" ToggledColor="Color.Info" 
                                                 Title="+20 Bonus" />
                        </MudTooltip>
                         <MudText Typo="Typo.caption">+20 Bonus</MudText>

                    </div>
                </MudPaper>

            </MudItem>

            <MudItem xs="12" md="3">
                <MudPaper Height="100%" Class="pa-3 d-flex flex-column" Outlined="true" Style="background-color: var(--mud-palette-background-grey);">
                    <div class="d-flex justify-space-between align-center mb-2">
                        <MudText Typo="Typo.h6">Modifiers</MudText>
                        <MudText Typo="Typo.h6" Color="@(TotalMods >= 0 ? Color.Success : Color.Error)">
                            @(TotalMods >= 0 ? "+" : "")@TotalMods
                        </MudText>
                    </div>

                    <MudSelect T="int" Label="Difficulty" Variant="Variant.Filled" Margin="Margin.Dense" Class="mb-4"
                               @bind-Value="_difficultyMod">
                        <MudSelectItem Value="30">Very Easy (+30)</MudSelectItem>
                        <MudSelectItem Value="10">Easy (+10)</MudSelectItem>
                        <MudSelectItem Value="0">Average (+0)</MudSelectItem>
                        <MudSelectItem Value="-10">Difficult (-10)</MudSelectItem>
                        <MudSelectItem Value="-30">Very Hard (-30)</MudSelectItem>
                    </MudSelect>

                    <div class="flex-grow-1 overflow-auto" style="max-height: 250px;">
                        @foreach (var mod in Modifiers)
                        {
                            <div class="d-flex justify-space-between align-center mb-1">
                                <MudCheckBox T="bool" @bind-Value="mod.IsActive" Label="@mod.Name" Dense="true" Size="Size.Small" Color="Color.Primary"/>
                                <MudText Typo="Typo.caption" Color="@(mod.Value >= 0 ? Color.Success : Color.Error)">
                                    @(mod.Value >= 0 ? "+" : "")@mod.Value
                                </MudText>
                            </div>
                        }
                    </div>

                    <MudDivider Class="my-2"/>
                    <div class="d-flex gap-1">
                         <MudTextField @bind-Value="_newModName" Placeholder="Custom" Margin="Margin.Dense" />
                         <MudNumericField @bind-Value="_newModValue" Placeholder="+/-" Margin="Margin.Dense" HideSpinButtons="true" Style="width:40px;"/>
                         <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="AddCustomMod" Size="Size.Small"/>
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4" Class="d-flex flex-column align-center justify-center">
                
                <MudText Typo="Typo.caption" Class="mb-1">TARGET NUMBER</MudText>
                <MudText Typo="Typo.h2" Color="Color.Primary" Class="mb-4">@EffectiveTarget</MudText>

                <MudPaper Elevation="4" Class="d-flex align-center justify-center mb-4 rounded-circle" 
                          Style="@($"width: 140px; height: 140px; background-color: {GetColorString(_resultColor)}; color: white; transition: background-color 0.3s;")">
                    <MudText Typo="Typo.h2">@_currentDisplayValue.ToString("D2")</MudText>
                </MudPaper>
                
                 @if (_hasRolled)
                {
                    <MudAlert Severity="@_resultSeverity" Variant="Variant.Filled" Class="w-100 mb-2" Dense="true">
                        @_resultMessage
                    </MudAlert>
                    
                     @if (_currentDisplayValue != GetFlippedValue(_currentDisplayValue))
                    {
                        <MudButton OnClick="FlipDice" Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small" StartIcon="@Icons.Material.Filled.SwapVert">
                            Flip (@GetFlippedValue(_currentDisplayValue))
                        </MudButton>
                    }
                }

                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Class="mt-auto w-100 py-2" 
                           OnClick="RollDice" Disabled="_isRolling">
                    @(_hasRolled ? "RE-ROLL TEST" : "START TEST")
                </MudButton>

            </MudItem>
        </MudGrid>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] public required IMudDialogInstance MudDialog { get; set; }
    [CascadingParameter(Name = "EgoModel")] public required Ego Ego { get; set; }
    
    [Parameter] public string SkillName { get; set; } = "Check";
    [Parameter] public string LinkedAptitude { get; set; } = "COG";
    [Parameter] public int BaseAptitudeValue { get; set; } = 15;
    [Parameter] public int BaseSkillTotal { get; set; } = 40; 
    [Parameter] public List<RollModifier> Modifiers { get; set; } = new();

    // UI State
    private string _actionType = "Complex";
    private string _actionSubtype = "Physical";
    private int _difficultyMod; // The Dropdown value
    private bool _ignoreMods;
    private bool _usePoolBonus;
    
    // Taking Time Logic
    private string _timeLabel = "Action";
    private int _timeBonus;

    private void OnTimeSliderChanged(int step)
    {
        switch (step)
        {
            case 0: _timeLabel = "Action"; _timeBonus = 0; break;
            case 1: _timeLabel = "Turn"; _timeBonus = 0; break;
            case 2: _timeLabel = "2 Turns"; _timeBonus = 10; break;
            case 3: _timeLabel = "1 Minute"; _timeBonus = 20; break;
            case 4: _timeLabel = "10 Mins"; _timeBonus = 30; break;
            case 5: _timeLabel = "1 Hour"; _timeBonus = 60; break; // EP2e rules vary, simplified here
        }
    }

    // --- MATH ---
    private int TotalMods 
    {
        get
        {
            int sum = _difficultyMod + _timeBonus;
            
            // Add List Modifiers
            int listSum = Modifiers.Where(m => m.IsActive).Sum(m => m.Value);
            
            // "Ignore Negative Mods" Logic (Only applies to environmental/situational usually, but effectively applies to list here)
            if (_ignoreMods && listSum < 0) listSum = 0;
            
            sum += listSum;
            
            if (_usePoolBonus) sum += 20;
            
            return sum;
        }
    }

    private int EffectiveTarget => BaseSkillTotal + TotalMods;

    // --- ROLLING LOGIC (Same as before) ---
    private int _currentDisplayValue;
    private bool _isRolling;
    private bool _hasRolled;
    private string _resultMessage = "";
    private Severity _resultSeverity = Severity.Info;
    private Color _resultColor = Color.Dark;
    
    // Custom Mod Inputs
    private string _newModName = "";
    private int _newModValue;

    private void AddCustomMod()
    {
        if (!string.IsNullOrWhiteSpace(_newModName) && _newModValue != 0)
        {
            Modifiers.Add(new RollModifier { Name = _newModName, Value = _newModValue, IsActive = true });
            _newModName = ""; _newModValue = 0;
        }
    }

    private async Task RollDice()
    {
        _isRolling = true; _hasRolled = false; _resultColor = Color.Info;
        for (int i = 0; i < 8; i++) { _currentDisplayValue = RandomNumberGenerator.GetInt32(0, 100); StateHasChanged(); await Task.Delay(50); }
        
        int roll = RandomNumberGenerator.GetInt32(0, 100);
        _currentDisplayValue = roll;
        CalculateResult(roll);
        _isRolling = false; _hasRolled = true;
    }

    private void CalculateResult(int roll)
    {
        int target = EffectiveTarget;
        bool isCrit = (roll % 11 == 0);
        
        if (roll == 99) { SetRes("CRITICAL FAILURE", Severity.Error, Color.Error); return; }
        if (roll == 00) { SetRes("CRITICAL SUCCESS", Severity.Success, Color.Success); return; }

        if (roll <= target)
        {
            if (isCrit) SetRes("CRITICAL SUCCESS", Severity.Success, Color.Warning);
            else if (roll >= 33) SetRes($"SUPERIOR SUCCESS {(roll >= 66 ? "(2)" : "(1)")}", Severity.Success, Color.Success);
            else SetRes("SUCCESS", Severity.Success, Color.Success);
        }
        else
        {
            if (isCrit) SetRes("CRITICAL FAILURE", Severity.Error, Color.Error);
            else SetRes("FAILURE", Severity.Warning, Color.Surface);
        }
    }

    private void SetRes(string m, Severity s, Color c) { _resultMessage = m; _resultSeverity = s; _resultColor = c; }
    private int GetFlippedValue(int original) { int ones = original % 10; int tens = original / 10; return (ones * 10) + tens; }
    private void FlipDice() { _currentDisplayValue = GetFlippedValue(_currentDisplayValue); CalculateResult(_currentDisplayValue); }
    private string GetColorString(Color c) => c switch { Color.Success => "#00c853", Color.Error => "#d32f2f", Color.Warning => "#ff9800", Color.Info => "#2196f3", Color.Surface => "#424242", _ => "#333333" };
}