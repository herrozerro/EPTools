@using EPTools.Blazor.ViewModels
@using EPTools.Core.Models.Ego
@inject IDialogService DialogService

<MudTable T="EgoSkill" Items="@CurrentEgo?.Skills" Breakpoint="Breakpoint.Sm" GroupBy="@_groupDefinition" GroupHeaderStyle="background-color:var(--mud-palette-background-gray)"
          GroupFooterClass="mb-4" Dense="true">
    <HeaderContent>
        <MudTh>Name</MudTh>
        <MudTh>Aptitude</MudTh>
        <MudTh>Specialization</MudTh>
        <MudTh>Rank</MudTh>
        <MudTh>Total</MudTh>
        <MudTh></MudTh>
        <MudTh></MudTh>
    </HeaderContent>
    <GroupHeaderTemplate>
        <MudTh Class="mud-table-cell-custom-group" colspan="4">@($"{context.GroupName}: {context.Key}")</MudTh>
        <MudTh colspan="3">
            @if (context.Key is not SkillType.EgoSkill)
            {
                <MudButton Color="Color.Primary" EndIcon="@Icons.Material.Filled.Add" Size="Size.Small" OnClick="@(() => HandleAddClick(context.Key))">Add</MudButton>           
            }
        </MudTh>
    </GroupHeaderTemplate>
    <RowTemplate>
        <MudTd DataLabel="Name">
            @switch (context.SkillType)
            {
                case SkillType.EgoSkill:
                    @context.Name
                    break;
                default:
                    <MudTextField T="string" @bind-Value="@context.Name"/>
                    break;
            }
        </MudTd>
        <MudTd DataLabel="Aptitude">
            @switch (context.SkillType)
            {
                case SkillType.ExoticSkill:
                    <MudSelect T="string" @bind-Value="@context.Aptitude">
                        @foreach (var aptitude in CurrentEgo.Aptitudes)
                        {
                            <MudSelectItem value="@aptitude.Name">@aptitude.Name</MudSelectItem>
                        }
                    </MudSelect>
                    break;
                case SkillType.KnowledgeSkill:
                    <MudSelect T="string" @bind-Value="@context.Aptitude">
                        @foreach (var aptitude in _knowAptitudes)
                        {
                            <MudSelectItem value="@aptitude">@aptitude</MudSelectItem>
                        }
                    </MudSelect>
                    break;
                default:
                    @context.Aptitude
                    break;
            }
        </MudTd>
        <MudTd DataLabel="Specialization"><MudTextField T="string" @bind-Value="@context.Specialization" /></MudTd>
        <MudTd DataLabel="Rank"><MudTextField T="int" @bind-Value="@context.Rank"/></MudTd>
        <MudTd>@CurrentEgo?.SkillTotal(context)</MudTd>
        <MudTd>
            <MudIconButton Icon="@Icons.Material.Filled.Casino" 
                           OnClick="@(() => OpenSkillCheck(context.Name, CurrentEgo.SkillTotal(context)))" 
                           Color="Color.Primary" />
        </MudTd>
        <MudTd>
            @if (context.SkillType is not SkillType.EgoSkill)
            {
                <MudButton Color="Color.Primary" EndIcon="@Icons.Material.Filled.Delete" Size="Size.Small" OnClick="@(() => DeleteSkill(context))"/>           
            }
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
    [CascadingParameter(Name = "EgoModel")] 
    public Ego? CurrentEgo { get; set; }

    private readonly IEnumerable<string> _knowAptitudes = ["Intuition", "Cognition"];
    
    // This is your new, safe helper method
    private async Task HandleAddClick(object key)
    {
        // Use 'is' for a safe cast
        if (key is SkillType type)
        {
            // The key was a valid SkillType, so invoke the parent's event
            Console.WriteLine($"SkillType was {type}.");
            CurrentEgo.Skills.Add(new EgoSkill{ SkillType = type, Name = "New Skill"});
        }
        else
        {
            // The cast failed (key was null or not a SkillType)
            // You can log this to see what's happening
            Console.WriteLine("Error: 'context.Key' was not a valid SkillType.");
        }
    }

    private async Task DeleteSkill(EgoSkill skillToDelete)
    {
        CurrentEgo.Skills.Remove(skillToDelete);
    }
    
    private readonly TableGroupDefinition<EgoSkill> _groupDefinition = new()
    {
        GroupName = "Type",
        Indentation = false,
        Expandable = false,
        Selector = (e) => e.SkillType
    };
    
    private async Task OpenSkillCheck(string skillName, int baseScore)
    {
        // 1. Prepare the list of modifiers
        var mods = new List<RollModifier>();

        
        var parameters = new DialogParameters<DiceRollerDialog>
        {
            { x => x.SkillName, skillName },
            { x => x.TargetNumber, baseScore },
            { x => x.Modifiers, mods } // Pass the list here
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        await DialogService.ShowAsync<DiceRollerDialog>("Roll", parameters, options);
    }
}
