@using EPTools.Core.Models.Ego

<MudPaper Class="pa-4">
    <MudGrid>
        <MudItem xs="12" Class="d-flex gap-2">
            <MudSelect T="Identity" 
                       Label="Active Alias / Identity" 
                       Variant="Variant.Outlined"
                       @bind-Value="_selectedIdentity"
                       ToStringFunc="@(id => id?.Alias ?? "Unknown")"
                       AnchorOrigin="Origin.BottomCenter">
                @foreach (var identity in Identities)
                {
                    <MudSelectItem Value="@identity">
                        @identity.Alias 
                        @if(!string.IsNullOrEmpty(identity.Location)) 
                        { 
                            <span class="mud-text-secondary ms-2">(@identity.Location)</span> 
                        }
                    </MudSelectItem>
                }
            </MudSelect>
            
            <MudIconButton Icon="@Icons.Material.Filled.Add" 
                           Color="Color.Primary" 
                           OnClick="CreateNewIdentity" 
                           Title="Add New Identity"/>
        </MudItem>

        @if (_selectedIdentity != null)
        {
            <MudItem xs="12">
                <MudDivider Class="my-2"/>
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="@_selectedIdentity.Alias" 
                              Label="Alias Name" 
                              Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="6">
                <MudTextField @bind-Value="@_selectedIdentity.Location" 
                              Label="Location / Mesh Address" 
                              Variant="Variant.Outlined" />
            </MudItem>

            <MudItem xs="12">
                <MudText Typo="Typo.subtitle2" Class="mt-2 mb-2">Reputation & Favors</MudText>

                <div class="d-flex flex-wrap gap-2 justify-center">
                    <RepWidget Label="@("@-rep (Anarchist)")" Rep="_selectedIdentity.ARep" />
                    <RepWidget Label="c-rep (Civic)"      Rep="_selectedIdentity.CRep" />
                    <RepWidget Label="f-rep (Fame)"       Rep="_selectedIdentity.FRep" />
                    <RepWidget Label="g-rep (Guanxi)"     Rep="_selectedIdentity.GRep" />
                    <RepWidget Label="i-rep (The Eye)"    Rep="_selectedIdentity.IRep" />
                    <RepWidget Label="r-rep (Research)"   Rep="_selectedIdentity.RRep" />
                    <RepWidget Label="x-rep (Explore)"    Rep="_selectedIdentity.XRep" />
                </div>
            </MudItem>
        }
        else
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Info">No Identities created yet.</MudAlert>
            </MudItem>
        }
    </MudGrid>
</MudPaper>

@code {
    [Parameter] 
    public required IEnumerable<Identity> Identities { get; set; }
    [Parameter] 
    public EventCallback<Identity> OnIdentityAdded { get; set; }
    private Identity? _selectedIdentity;
    
    // Define the width once here to keep them uniform
    private string RepStyle = "width: 85px;";

    protected override void OnParametersSet()
    {
        // 1. Safety Check: If the new list is null or empty, clear selection.
        if (!Identities.Any())
        {
            _selectedIdentity = null;
            return;
        }

        // 2. If we currently have an identity selected...
        if (_selectedIdentity != null)
        {
            // Check if an identity with the same ID exists in the NEW list.
            // (We match by ID because the object reference might be different after a reload)
            var matchInNewList = Identities.FirstOrDefault(x => x.Id == _selectedIdentity.Id);

            if (matchInNewList != null)
            {
                // CRITICAL: Swap to the new object reference!
                // If we don't do this, the form will be bound to the OLD (stale) object,
                // and changes won't appear in your main list.
                _selectedIdentity = matchInNewList;
                return;
            }
        }

        // 3. Fallback: If selection was null, or the old selection isn't in the new list,
        // pick the first one available.
        _selectedIdentity = Identities.First();
    }
    
    
    // 2. Trigger the event
    private async Task CreateNewIdentity()
    {
        var newId = new Identity { Alias = "New Cover ID", Location = "Unknown" };
        
        // Notify the parent
        await OnIdentityAdded.InvokeAsync(newId);
        
        // Select the new item locally
        _selectedIdentity = newId;
    }
}