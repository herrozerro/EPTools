@using EPTools.Blazor.Components.Dialogs
@using EPTools.Core.Models.Ego
@using EPTools.Core.Models.EPDataModels
@inject IDialogService DialogService
@inject IEpDataService EpDataService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-0">
    <MudGrid Spacing="4">
        <MudItem xs="12" md="3">
            <MudPaper Class="pa-4 h-100" Outlined="true" Style="border-top: 4px solid var(--mud-palette-tertiary);">
                <div class="d-flex align-center gap-2 mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Psychology" Color="Color.Tertiary" Size="Size.Large"/>
                    <div>
                        <MudText Typo="Typo.h6">Ego Traits</MudText>
                        <MudText Typo="Typo.caption">Personality & Flaws</MudText>
                    </div>
                </div>
                <MudDivider Class="my-3"/>
                <div class="d-flex justify-space-between align-center mb-1">
                    <MudText Typo="Typo.body2">Positive Traits</MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Success" Variant="Variant.Outlined">
                        @EgoTraits.Where(t => t.Type == "Positive").Sum(t => t.Cost) CP
                    </MudChip>
                </div>
                <div class="d-flex justify-space-between align-center mb-1">
                    <MudText Typo="Typo.body2">Negative Traits</MudText>
                    <MudChip T="string" Size="Size.Small" Color="Color.Error" Variant="Variant.Outlined">
                        @EgoTraits.Where(t => t.Type == "Negative").Sum(t => t.Cost) CP
                    </MudChip>
                </div>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="9">
            <MudPaper Class="pa-4 h-100" Outlined="true">
                <MudTable T="EgoTrait" 
                          Items="@EgoTraits" 
                          Dense="true" 
                          Hover="true" 
                          Striped="true" 
                          Elevation="0"
                          OnRowClick="TraitRowClick"
                          RowClass="cursor-pointer">
                    
                    <ToolBarContent>
                        <MudText Typo="Typo.h6">Active Traits</MudText>
                        <MudSpacer />
                        <MudMenu StartIcon="@Icons.Material.Filled.Add" Label="Add Trait" Color="Color.Primary" Variant="Variant.Filled">
                            <MudMenuItem OnClick="OpenTraitPicker">From Catalog...</MudMenuItem>
                            <MudMenuItem OnClick="AddCustomTrait">Custom Trait</MudMenuItem>
                        </MudMenu>
                    </ToolBarContent>

                    <HeaderContent>
                        <MudTh>Name</MudTh>
                        <MudTh>Type</MudTh>
                        <MudTh>Level</MudTh>
                        <MudTh>Summary</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    
                    <RowTemplate>
                        <MudTd DataLabel="Name">
                            <MudText Typo="Typo.body2" Style="font-weight:bold;">@context.Name</MudText>
                        </MudTd>
                        
                        <MudTd DataLabel="Type">
                            <MudChip T="string" Size="Size.Small" Color="@GetTypeColor(context.Type)" Variant="Variant.Text">@context.Type</MudChip>
                        </MudTd>
                        
                        <MudTd DataLabel="Level">
                            <div @onclick:stopPropagation="true">
                                <MudNumericField @bind-Value="@context.Level" Margin="Margin.Dense" HideSpinButtons="true" Style="width:40px;" Variant="Variant.Text"/>
                            </div>
                        </MudTd>
                        
                        <MudTd DataLabel="Summary">
                             <MudText Typo="Typo.caption">@context.Summary</MudText>
                        </MudTd>
                        
                        <MudTd Style="text-align:right">
                            <div @onclick:stopPropagation="true">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => EgoTraits.Remove(context))"/>
                            </div>
                        </MudTd>
                    </RowTemplate>
                    
                    <NoRecordsContent>
                         <MudText Typo="Typo.caption" Class="pa-4">No traits selected.</MudText>
                    </NoRecordsContent>
                </MudTable>
            </MudPaper>
        </MudItem>

    </MudGrid>
</MudContainer>

@code {
    [Parameter] public List<EgoTrait> EgoTraits { get; set; } = [];

    // --- ROW CLICK HANDLER ---
    private async Task TraitRowClick(TableRowClickEventArgs<EgoTrait> args)
    {
        // args.Item contains the Trait object of the row clicked
        if (args.Item != null) await ShowTraitDetails(args.Item);
    }

    private Color GetTypeColor(string type) => type.ToLower() switch
    {
        "positive" => Color.Success,
        "negative" => Color.Error,
        "neutral" => Color.Info,
        _ => Color.Default
    };

    // --- ACTIONS ---

    private async Task OpenTraitPicker()
    {
        var allTraits = await EpDataService.GetTraitsAsync();
        var parameters = new DialogParameters<TraitPickerDialog> { { x => x.TraitList, allTraits } };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<TraitPickerDialog>("Select Trait", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: Trait selectedRecord })
        {
            var newTrait = new EgoTrait
            {
                Name = selectedRecord.Name,
                Type = selectedRecord.Type,
                Level = 1,
                Cost = selectedRecord.Cost.FirstOrDefault(),
                CostTiers = string.Join(",", selectedRecord.Cost),
                Summary = selectedRecord.Summary,
                Description = selectedRecord.Description,
                AdditionalRules = selectedRecord.AdditionalRules
            };
            EgoTraits.Add(newTrait);
            Snackbar.Add($"Added {newTrait.Name}", Severity.Success);
        }
    }

    private void AddCustomTrait()
    {
        EgoTraits.Add(new EgoTrait { Name = "New Trait", Type = "Positive", Level = 10, Summary = "Custom.", Description = "" });
    }

    // Opens your full editor dialog
    private async Task ShowTraitDetails(EgoTrait trait)
    {
        var parameters = new DialogParameters<EgoTraitDetailDialog> { { x => x.OriginalTrait, trait } };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        
        var dialog = await DialogService.ShowAsync<EgoTraitDetailDialog>("Edit Trait", parameters, options);
        var result = await dialog.Result;

        if (result is { Canceled: false, Data: EgoTrait updatedTrait})
        {
            var index = EgoTraits.IndexOf(trait);
            if (index != -1)
            {
                EgoTraits[index] = updatedTrait;
                Snackbar.Add("Trait updated.", Severity.Success);
            }
        }
    }
}